<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Connexion – ContextaLingua</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body class="page">
    <!-- Header -->
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="header-logo">
          <span class="contexta">Contexta</span>
          <span class="lingua">Lingua</span>
        </a>

        <nav class="main-nav">
          <a href="produit.html" class="nav-link">Produit</a>
      <a href="tarifs.html" class="nav-link">Tarifs</a>
      <a href="faq.html" class="nav-link">FAQ</a>
      <a href="dashboard.html" class="nav-link">Tableau de bord</a>
      <a href="generate.html" class="nav-link">Rédaction</a>
      <a href="interpret.html" class="nav-link">Interprétation</a>
      <a href="accompanied.html" class="nav-link">Mode accompagné</a>
        </nav>

        <div class="header-actions">
          <a href="login.html" class="btn btn-ghost">Se connecter</a>
          <a href="register.html" class="btn btn-primary">Commencer gratuitement</a>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="container hero-inner hero-grid hero-grid-simple">
          <div class="card" style="max-width: 420px; margin: 0 auto;">
            <h1>Connexion</h1>
            <p style="margin-top: 8px; color: var(--text-muted);">
              Accédez à votre espace ContextaLingua.
            </p>

            <!-- Formulaire de connexion -->
            <form id="loginForm" onsubmit="return handleLogin(event)" style="margin-top: 20px;">
              <div class="form-field">
                <label for="loginEmail">Email</label>
                <input
                  type="email"
                  id="loginEmail"
                  placeholder="vous@exemple.com"
                  required
                />
              </div>

              <div class="form-field">
                <label for="loginPassword">Mot de passe</label>
                <input
                  type="password"
                  id="loginPassword"
                  placeholder="Votre mot de passe"
                  required
                />
              </div>

              <p
                id="loginError"
                style="margin-top: 6px; font-size: 0.9rem; color: var(--danger); min-height: 1.2em;"
              ></p>

              <button
                type="submit"
                class="btn btn-primary btn-large btn-full"
                style="margin-top: 14px;"
              >
                Se connecter
              </button>

              <p
                style="
                  margin-top: 14px;
                  font-size: 0.9rem;
                  color: var(--text-muted);
                "
              >
                Pas encore de compte ?
                <a href="register.html" style="color: var(--accent-strong);">
                  Créer un compte
                </a>
              </p>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <span>© ContextaLingua</span>
        <nav class="footer-nav">
          <a href="contact.html">Contact</a>
        </nav>
      </div>
    </footer>

    <!-- Script de login AUTONOME -->
    <script>
      const API_BASE_URL = "http://localhost:4000/api"; // à adapter plus tard si besoin

      async function handleLogin(event) {
        event.preventDefault();
        console.log("[Login] submit déclenché");

        const emailInput = document.getElementById("loginEmail");
        const passwordInput = document.getElementById("loginPassword");
        const errorEl = document.getElementById("loginError");

        if (errorEl) errorEl.textContent = "";

        const email = emailInput ? emailInput.value.trim() : "";
        const password = passwordInput ? passwordInput.value : "";

        if (!email || !password) {
          if (errorEl) {
            errorEl.textContent = "Email et mot de passe requis.";
          }
          return false;
        }

        try {
          const response = await fetch(API_BASE_URL + "/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ email, password })
          });

          console.log("[Login] status:", response.status);

          let data = null;
          const text = await response.text();
          if (text) {
            try {
              data = JSON.parse(text);
            } catch (e) {
              console.warn("Réponse non JSON :", text);
              data = { raw: text };
            }
          }

          if (!response.ok) {
            if (errorEl) {
              if (response.status === 401) {
                errorEl.textContent = "Identifiants invalides.";
              } else {
                errorEl.textContent =
                  (data && data.message) ||
                  "Erreur lors de la connexion (code " + response.status + ").";
              }
            }
            return false;
          }

          if (!data || !data.token || !data.user) {
            if (errorEl) {
              errorEl.textContent =
                "Réponse inattendue du serveur. Vérifiez le backend.";
            }
            console.log("[Login] data reçu :", data);
            return false;
          }

          // Stockage du token et de l'utilisateur
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));

          console.log("[Login] connexion OK, redirection vers dashboard.html");
          window.location.href = "dashboard.html";
          return false;
        } catch (err) {
          console.error("[Login] erreur réseau :", err);
          if (errorEl) {
            errorEl.textContent =
              "Impossible de contacter le serveur (API hors ligne ?).";
          }
          return false;
        }
      }

      // On expose la fonction dans le scope global pour onsubmit
      window.handleLogin = handleLogin;
    </script>
  </body>
</html>
